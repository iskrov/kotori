# Cloud Build configuration for running database migrations
# Uses the existing backend Docker image to run migrations from Google Cloud environment

steps:
  # Build the backend image (same as deployment)
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/kotori-io/kotori-images/kotori-api:migration-${SHORT_SHA}'
      - '.'
    dir: 'backend'

  # Create database backup before migration
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "ðŸ”„ Creating database backup before migration..."
        BACKUP_DESCRIPTION="pre-migration-$$(date +%Y%m%d-%H%M%S)"
        if gcloud sql backups create \
          --instance=kotori-db \
          --description="$$BACKUP_DESCRIPTION" \
          --project=kotori-io; then
          echo "âœ… Backup created: $$BACKUP_DESCRIPTION"
        else
          echo "âš ï¸  Backup creation failed; continuing with migration as per policy"
        fi

  # Run database migrations using the backend container
  - name: 'us-central1-docker.pkg.dev/kotori-io/kotori-images/kotori-api:migration-${SHORT_SHA}'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "ðŸ” Starting migration process..."
        cd /app
        
        # Ensure dependencies available in runtime container
        pip install --user -r requirements.txt >/dev/null 2>&1 || true
        export PATH="/home/kotori/.local/bin:$PATH"
        
        echo "Alembic version: $(alembic --version || echo 'not found')"
        
        # Check current migration status
        echo "ðŸ“Š Current migration status:"
        alembic current || true
        
        # Show target revision
        echo "ðŸŽ¯ Target revision:"
        alembic heads
        
        # Preview migrations (limited output to avoid issues)
        echo "ðŸ‘€ Migration preview (first 10 operations):"
        alembic upgrade head --sql | grep -E "(CREATE|ALTER|DROP|INSERT|UPDATE)" | head -10 || true
        
        # Execute migrations (fail hard on error)
        echo "ðŸš€ Executing database migrations..."
        alembic upgrade head
        
        # Verify success
        echo "âœ… Post-migration status:"
        alembic current
        
        echo "ðŸŽ‰ Database migrations completed successfully!"
    secretEnv:
      - 'DATABASE_URL'

availableSecrets:
  secretManager:
    - versionName: projects/kotori-io/secrets/database-url/versions/latest
      env: DATABASE_URL

# Build configuration
timeout: '1200s'
options:
  logging: CLOUD_LOGGING_ONLY
  pool:
    name: projects/kotori-io/locations/us-central1/workerPools/private-pool
