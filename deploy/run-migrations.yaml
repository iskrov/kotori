# Cloud Build configuration for running database migrations
# Uses the existing backend Docker image to run migrations from Google Cloud environment

steps:
  # Build the backend image (same as deployment)
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/kotori-io/kotori-images/kotori-api:migration-${SHORT_SHA}'
      - '.'
    dir: 'backend'

  # Create database backup before migration
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "🔄 Creating database backup before migration..."
        BACKUP_DESCRIPTION="pre-migration-$$(date +%Y%m%d-%H%M%S)"
        gcloud sql backups create \
          --instance=kotori-db-instance \
          --description="$$BACKUP_DESCRIPTION" \
          --project=kotori-io
        echo "✅ Backup created: $$BACKUP_DESCRIPTION"

  # Run database migrations using the backend container
  - name: 'us-central1-docker.pkg.dev/kotori-io/kotori-images/kotori-api:migration-${SHORT_SHA}'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "🔍 Starting migration process..."
        cd /app
        
        # Check current migration status
        echo "📊 Current migration status:"
        alembic current || echo "No current revision found"
        
        # Show target revision
        echo "🎯 Target revision:"
        alembic heads
        
        # Preview migrations (limited output to avoid issues)
        echo "👀 Migration preview (first 10 operations):"
        timeout 30s alembic upgrade head --sql | grep -E "(CREATE|ALTER|DROP|INSERT|UPDATE)" | head -10 || echo "Preview completed or timed out"
        
        # Execute migrations
        echo "🚀 Executing database migrations..."
        alembic upgrade head
        
        # Verify success
        echo "✅ Post-migration status:"
        alembic current
        
        echo "🎉 Database migrations completed successfully!"
    secretEnv:
      - 'DATABASE_URL'

availableSecrets:
  secretManager:
    - versionName: projects/kotori-io/secrets/database-url/versions/latest
      env: DATABASE_URL

# Build configuration
timeout: '1200s'
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  pool:
    name: projects/kotori-io/locations/us-central1/workerPools/private-pool
