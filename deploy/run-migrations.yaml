# Cloud Build configuration for running database migrations
# Uses the existing backend Docker image to run migrations from Google Cloud environment

steps:
  # Build the backend image (same as deployment)
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/kotori-io/kotori-images/kotori-api:migration-${SHORT_SHA}'
      - '.'
    dir: 'backend'

  # Create database backup before migration
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "üîÑ Creating database backup before migration..."
        BACKUP_DESCRIPTION="pre-migration-$$(date +%Y%m%d-%H%M%S)"
        if gcloud sql backups create \
          --instance=kotori-db \
          --description="$$BACKUP_DESCRIPTION" \
          --project=kotori-io; then
          echo "‚úÖ Backup created: $$BACKUP_DESCRIPTION"
        else
          echo "‚ö†Ô∏è  Backup creation failed; continuing with migration as per policy"
        fi

  # Run database migrations using the backend container
  - name: 'us-central1-docker.pkg.dev/kotori-io/kotori-images/kotori-api:migration-${SHORT_SHA}'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "üîç Starting migration process..."
        cd /app
        
        # Ensure dependencies available in runtime container (succeeds or fails build)
        export PATH="/home/kotori/.local/bin:$PATH"
        python -m pip install --user --no-cache-dir -r requirements.txt
        echo "Alembic version: $(alembic --version)"
        
        # Check current migration status
        echo "üìä Current migration status:"
        alembic current || true
        
        # Show target revision
        echo "üéØ Target revision:"
        alembic heads
        
        # Preview migrations (limited output to avoid issues)
        echo "üëÄ Migration preview (first 10 operations):"
        alembic upgrade head --sql | grep -E "(CREATE|ALTER|DROP|INSERT|UPDATE)" | head -10 || true
        
        # Execute migrations (fail hard on error)
        echo "üöÄ Executing database migrations..."
        alembic upgrade head
        
        # Verify success
        echo "‚úÖ Post-migration status:"
        alembic current
        
        echo "üéâ Database migrations completed successfully!"
    secretEnv:
      - 'DATABASE_URL'

availableSecrets:
  secretManager:
    - versionName: projects/kotori-io/secrets/database-url/versions/latest
      env: DATABASE_URL

# Build configuration
timeout: '1200s'
options:
  logging: CLOUD_LOGGING_ONLY
  pool:
    name: projects/kotori-io/locations/us-central1/workerPools/private-pool
