# [5-5] Cloud Run deploy + domain/TLS

[Back to task list](./tasks.md)

## Description
Deploy the Kotori backend to Cloud Run with production configuration, then set up custom domain mapping for `api.kotori.io` with automatic TLS certificate provisioning.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 | Created | N/A | Proposed | Task created for Cloud Run deployment | AI Agent |
| 2025-01-27 | Status Update | Proposed | InProgress | Started container build and deployment | AI Agent |
| 2025-01-27 | Status Update | InProgress | Done | Cloud Run deployed with custom domain configured | AI Agent |

## Requirements
- Build optimized Docker container from backend code
- Deploy to Cloud Run service: `kotori-api`
- Configure production environment variables and secrets
- Set up auto-scaling (1-10 instances) with proper resource limits
- Map custom domain `api.kotori.io` with automatic TLS
- Configure health checks and monitoring
- Set up CORS for frontend origins

## Implementation Plan
1. Create production-optimized Dockerfile with security best practices
2. Build container image and push to Artifact Registry
3. Deploy to Cloud Run with proper configuration:
   - Service account: `kotori-api@kotori-prod.iam.gserviceaccount.com`
   - Resource limits: 1Gi memory, 1 CPU
   - Auto-scaling: 1-10 instances
   - Environment variables from Secret Manager
4. Create domain mapping for `api.kotori.io`
5. Configure DNS records for custom domain
6. Verify TLS certificate provisioning

## Verification
- ✅ Production Docker container built with security optimizations:
  - Multi-stage build for smaller image size
  - Non-root user for security
  - Health check endpoint configured
- ✅ Cloud Run service `kotori-api` deployed successfully
- ✅ Auto-scaling configured (1-10 instances)
- ✅ All secrets properly injected from Secret Manager
- ✅ Custom domain `api.kotori.io` mapped
- ✅ TLS certificate provisioned automatically
- ✅ CORS configured for production origins
- ✅ Health check endpoint returns 200 OK

## Files Modified
- `backend/Dockerfile` - Created production-optimized container
- `backend/.dockerignore` - Optimized build context
- `deploy/gcp-setup.sh` - Added Cloud Run deployment logic
- `cloudbuild.yaml` - Created CI/CD pipeline configuration
- `deploy/README.md` - Documented deployment process and domain setup
