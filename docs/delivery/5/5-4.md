# [5-4] Secret Manager wiring

[Back to task list](./tasks.md)

## Description
Generate secure secrets and configure Google Secret Manager to store all sensitive configuration values, then wire them to Cloud Run for secure access.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 | Created | N/A | Proposed | Task created for Secret Manager integration | AI Agent |
| 2025-01-27 | Status Update | Proposed | InProgress | Started secret generation and storage | AI Agent |
| 2025-01-27 | Status Update | InProgress | Done | All secrets generated and wired to Cloud Run | AI Agent |

## Requirements
Generate and store the following secrets in Secret Manager:
- `database-url`: PostgreSQL connection string with credentials
- `secret-key`: JWT signing key (64 characters, cryptographically secure)
- `encryption-master-salt`: Per-user encryption salt (64 characters)
- `google-cloud-project`: GCP project ID (`kotori-prod`)
- `google-cloud-location`: GCP region (`northamerica-northeast2`)

Configure Cloud Run to access secrets as environment variables with proper IAM permissions.

## Implementation Plan
1. Generate cryptographically secure secrets using OpenSSL
2. Store each secret in Google Secret Manager
3. Configure IAM permissions for service account to access secrets
4. Wire secrets to Cloud Run as environment variables
5. Verify secure access and proper injection

## Verification
- ✅ All secrets generated with cryptographic security:
  - SECRET_KEY: 64-character hex string
  - ENCRYPTION_MASTER_SALT: 64-character hex string  
  - Database password: 32-character alphanumeric
- ✅ Secrets stored in Secret Manager with proper versioning
- ✅ Service account granted `roles/secretmanager.secretAccessor`
- ✅ Cloud Run configured to inject secrets as environment variables
- ✅ Secret access verified in deployment

## Files Modified
- `deploy/gcp-setup.sh` - Added secret generation and storage logic
- `deploy/GENERATED_SECRETS.md` - Documented all generated secrets securely
- `cloudbuild.yaml` - Configured secret injection for CI/CD
- `deploy/production.env.template` - Documented secret structure
