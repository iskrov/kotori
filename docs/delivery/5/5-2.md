# [5-2] Service account and IAM roles

[Back to task list](./tasks.md)

## Description
Create a dedicated service account for the Kotori API with least-privilege IAM roles for secure access to Google Cloud services.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 | Created | N/A | Proposed | Task created for service account setup | AI Agent |
| 2025-01-27 | Status Update | Proposed | InProgress | Started service account creation | AI Agent |
| 2025-01-27 | Status Update | InProgress | Done | Service account created with least-privilege roles | AI Agent |

## Requirements
- Create service account: `kotori-api@kotori-prod.iam.gserviceaccount.com`
- Grant minimum required IAM roles:
  - `roles/cloudsql.client` - Cloud SQL database access
  - `roles/secretmanager.secretAccessor` - Secret Manager read access
  - `roles/speech.client` - Speech-to-Text API access
  - `roles/storage.objectAdmin` - Cloud Storage access (if needed)
  - `roles/logging.logWriter` - Cloud Logging
  - `roles/monitoring.metricWriter` - Cloud Monitoring

## Implementation Plan
1. Create service account with descriptive name and display name
2. Grant only necessary IAM roles following least-privilege principle
3. Configure Cloud Run service to use this service account
4. Verify permissions are working correctly

## Verification
- ✅ Service account `kotori-api@kotori-prod.iam.gserviceaccount.com` created
- ✅ All required IAM roles granted with least-privilege access
- ✅ Service account configured in Cloud Run deployment
- ✅ Permissions verified for all required services

## Files Modified
- `deploy/gcp-setup.sh` - Added service account creation and IAM configuration
- `deploy/README.md` - Documented service account details and permissions
- `cloudbuild.yaml` - Configured to use service account for deployments
