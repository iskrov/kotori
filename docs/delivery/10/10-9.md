# [10-9] Import template from file (PDF/DOCX)

## Description
Enable users to upload a structured questionnaire (PDF/DOCX) and automatically extract a template (questions, types, options) using Gemini. Users can then review/edit the extracted template before generating answers from their journal entries.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 15:20:00 | Created | N/A | Proposed | Task created | ai-agent |

## Requirements

### Functional
- Accept file upload (PDF/DOCX) from the UI
- Parse text content from uploaded files (digital PDFs/DOCX only in MVP)
- Call Gemini to extract a strict JSON question set
- Show extracted questions to the user for review/edit
- Persist the extracted template transiently for the current share flow

### Non-Functional
- Max file size: 5–10 MB, enforce and show friendly errors
- Typical extraction in < 10s for ≤5 pages
- Ephemeral storage; delete uploaded files ≤24h

### Security/Privacy
- MIME/type validation and simple content scanning
- Do not log document content; only minimal metadata
- Explicit consent for sending document text to Gemini

## Implementation Plan

### Backend (FastAPI)
- New endpoint: `POST /api/v1/share/import-template` (auth required)
  - Accept `multipart/form-data` with file
  - Validate type/size; reject images/scans in MVP
  - Extract text:
    - PDF: `pdfminer.six` or `pypdf`
    - DOCX: `python-docx`
  - Normalize into clean text/markdown
  - Call `GeminiTemplateExtractor.extract(text)` to get a JSON schema:
    ```json
    {
      "template_id": "imported-<hash>",
      "name": "Imported Template",
      "questions": [
        { "id": "q1", "text": {"en": "..."}, "type": "open", "options": [] }
      ]
    }
    ```
  - Validate JSON (Pydantic) and return

- Service: `backend/app/services/template_extractor_service.py`
  - Prompt engineering with clear schema and few-shot examples
  - Re-prompt on invalid JSON

- Config: add file size limits and allowed types

### Frontend (React Native/Web)
- Update Share Config screen:
  - Add "Import template from file" button
  - Use file picker (web) and document picker (mobile)
  - Show upload progress and extraction steps
- Review screen for imported template:
  - List of questions (editable text/type/options)
  - Confirm to proceed

## Verification

### Unit Tests
- Text extraction from sample PDFs and DOCX
- Schema validation (happy path and failures)
- Prompt response parsing and re-prompt

### Integration Tests
- End-to-end upload → extract → review → generate
- Size/format validation errors

### Manual Tests
- 1–5 page digital PDFs, DOCX samples
- Edge cases: bullet lists, numbered sections, tables (converted to questions)

## Files Modified
- New: `backend/app/services/template_extractor_service.py`
- New: `backend/app/api/v1/endpoints/share_import.py`
- New: `backend/app/schemas/share_import.py`
- New: `frontend/src/components/share/ImportTemplateButton.tsx`
- Update: `frontend/src/screens/main/ShareConfigScreen.tsx`
- Update: `frontend/src/services/api.ts` (import endpoint)

## Estimated Time
- Backend: 2–3 days
- Frontend: 1–2 days
- Testing/polish: 0.5–1 day

## Dependencies
- Task 10-2 (Gemini integration)
- Task 10-1 (Template schemas)

## Notes
- OCR for scanned PDFs/images deferred to a follow-up PBI
- Tables and checkboxes: extract as multiple-choice when clear; otherwise default to open-ended

[Back to task list](./tasks.md)
