# [10-5] Create sharing UI screens

## Description

Build the complete frontend user interface for the sharing feature, including configuration, preview/edit, and share screens. Implement the flow from journal selection through final PDF download or email sending.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 15:00:00 | Created | N/A | Proposed | Task created | ai-agent |

## Requirements

### Functional Requirements
- Date range selector for journal entries
- Template selector with descriptions
- Language selector for output
- Preview screen with editable Q&A pairs
- PDF download with native share sheet
- Email sending UI (if configured)
- Clear consent messaging

### Technical Requirements
- React Native components for mobile
- Responsive web components
- Maintain calm visual design
- Accessibility compliance (WCAG AA)
- Smooth transitions between screens

## Implementation Plan

### 1. Share Configuration Screen (2 hours)

```typescript
// frontend/src/screens/main/ShareConfigScreen.tsx

import React, { useState } from 'react';
import { View, ScrollView, Text } from 'react-native';
import DateRangePicker from '../../components/DateRangePicker';
import TemplateSelector from '../../components/TemplateSelector';
import LanguageSelector from '../../components/LanguageSelector';

const ShareConfigScreen = ({ navigation }) => {
  const [dateRange, setDateRange] = useState({ 
    start: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
    end: new Date() 
  });
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [targetLanguage, setTargetLanguage] = useState('en');
  
  const handleNext = async () => {
    // Decrypt selected entries
    const entries = await getEntriesInRange(dateRange);
    
    // Show consent dialog
    const consent = await showConsentDialog();
    if (!consent) return;
    
    // Navigate to processing
    navigation.navigate('ShareProcessing', {
      entries,
      template: selectedTemplate,
      language: targetLanguage
    });
  };
  
  return (
    <ScrollView style={styles.container}>
      <ScreenHeader title="Share Summary" onBack={() => navigation.goBack()} />
      
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Select Time Period</Text>
        <DateRangePicker
          startDate={dateRange.start}
          endDate={dateRange.end}
          onRangeChange={setDateRange}
        />
      </View>
      
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Choose Template</Text>
        <TemplateSelector
          value={selectedTemplate}
          onChange={setSelectedTemplate}
        />
      </View>
      
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Output Language</Text>
        <LanguageSelector
          value={targetLanguage}
          onChange={setTargetLanguage}
        />
      </View>
      
      <ConsentNotice />
      
      <Button
        title="Generate Summary"
        onPress={handleNext}
        disabled={!selectedTemplate}
        style={styles.primaryButton}
      />
    </ScrollView>
  );
};
```

### 2. Processing Screen (1 hour)

```typescript
// frontend/src/screens/main/ShareProcessingScreen.tsx

const ShareProcessingScreen = ({ route, navigation }) => {
  const { entries, template, language } = route.params;
  const [progress, setProgress] = useState(0);
  const [status, setStatus] = useState('Preparing entries...');
  
  useEffect(() => {
    generateSummary();
  }, []);
  
  const generateSummary = async () => {
    try {
      setStatus('Decrypting entries...');
      setProgress(20);
      
      const decryptedEntries = await decryptEntries(entries);
      
      setStatus('Generating summary with AI...');
      setProgress(50);
      
      const summary = await api.generateShareSummary({
        entries: decryptedEntries,
        templateId: template.id,
        targetLanguage: language
      });
      
      setProgress(100);
      setStatus('Complete!');
      
      navigation.replace('SharePreview', { summary });
      
    } catch (error) {
      Alert.alert('Error', 'Failed to generate summary');
      navigation.goBack();
    }
  };
  
  return (
    <View style={styles.container}>
      <ActivityIndicator size="large" color={theme.colors.primary} />
      <Text style={styles.status}>{status}</Text>
      <ProgressBar progress={progress} />
    </View>
  );
};
```

### 3. Preview & Edit Screen (2 hours)

```typescript
// frontend/src/screens/main/SharePreviewScreen.tsx

const SharePreviewScreen = ({ route, navigation }) => {
  const { summary } = route.params;
  const [editedAnswers, setEditedAnswers] = useState(summary.answers);
  const [isEditing, setIsEditing] = useState(false);
  
  const handleEdit = (questionId, newAnswer) => {
    setEditedAnswers(prev => 
      prev.map(qa => 
        qa.question_id === questionId 
          ? { ...qa, answer: newAnswer }
          : qa
      )
    );
  };
  
  const handleShare = async () => {
    const finalSummary = { ...summary, answers: editedAnswers };
    navigation.navigate('ShareExport', { summary: finalSummary });
  };
  
  return (
    <ScrollView style={styles.container}>
      <ScreenHeader 
        title="Review Summary" 
        onBack={() => navigation.goBack()}
        rightAction={{
          icon: isEditing ? 'check' : 'edit',
          onPress: () => setIsEditing(!isEditing)
        }}
      />
      
      <View style={styles.summaryContainer}>
        {editedAnswers.map((qa) => (
          <View key={qa.question_id} style={styles.qaCard}>
            <Text style={styles.question}>{qa.question_text}</Text>
            {isEditing ? (
              <TextInput
                style={styles.answerInput}
                value={qa.answer}
                onChangeText={(text) => handleEdit(qa.question_id, text)}
                multiline
                numberOfLines={4}
              />
            ) : (
              <Text style={styles.answer}>{qa.answer}</Text>
            )}
          </View>
        ))}
      </View>
      
      <View style={styles.metadata}>
        <Text style={styles.metaText}>
          Generated from {summary.entry_count} entries
        </Text>
        <Text style={styles.metaText}>
          Language: {summary.target_language}
        </Text>
      </View>
      
      <Button
        title="Share Summary"
        onPress={handleShare}
        style={styles.primaryButton}
      />
    </ScrollView>
  );
};
```

### 4. Export Screen (1.5 hours)

```typescript
// frontend/src/screens/main/ShareExportScreen.tsx

const ShareExportScreen = ({ route, navigation }) => {
  const { summary } = route.params;
  const [pdfUri, setPdfUri] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);
  
  const generatePDF = async () => {
    setIsGenerating(true);
    try {
      const pdf = await api.generatePDF(summary);
      setPdfUri(pdf.uri);
    } catch (error) {
      Alert.alert('Error', 'Failed to generate PDF');
    }
    setIsGenerating(false);
  };
  
  const handleDownload = async () => {
    if (!pdfUri) await generatePDF();
    
    if (Platform.OS === 'web') {
      // Web download
      const link = document.createElement('a');
      link.href = pdfUri;
      link.download = `summary_${Date.now()}.pdf`;
      link.click();
    } else {
      // Mobile share sheet
      await Sharing.shareAsync(pdfUri, {
        mimeType: 'application/pdf',
        dialogTitle: 'Share Summary'
      });
    }
  };
  
  const handleEmail = async () => {
    navigation.navigate('ShareEmail', { summary, pdfUri });
  };
  
  return (
    <View style={styles.container}>
      <ScreenHeader 
        title="Share Options" 
        onBack={() => navigation.goBack()}
      />
      
      <View style={styles.successMessage}>
        <Icon name="check-circle" size={48} color={theme.colors.success} />
        <Text style={styles.successText}>Summary Ready!</Text>
      </View>
      
      <View style={styles.actions}>
        <TouchableOpacity 
          style={styles.actionCard} 
          onPress={handleDownload}
          disabled={isGenerating}
        >
          <Icon name="download" size={32} />
          <Text style={styles.actionTitle}>Download PDF</Text>
          <Text style={styles.actionDesc}>
            Save to device or share via apps
          </Text>
        </TouchableOpacity>
        
        <TouchableOpacity 
          style={styles.actionCard} 
          onPress={handleEmail}
        >
          <Icon name="mail" size={32} />
          <Text style={styles.actionTitle}>Send via Email</Text>
          <Text style={styles.actionDesc}>
            Email directly to recipient
          </Text>
        </TouchableOpacity>
      </View>
      
      <View style={styles.privacy}>
        <Icon name="info" size={16} />
        <Text style={styles.privacyText}>
          This summary will be available for 7 days
        </Text>
      </View>
    </View>
  );
};
```

### 5. Component Styling (30 mins)

```typescript
// frontend/src/styles/shareStyles.ts

export const shareStyles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: theme.colors.background,
  },
  section: {
    padding: 16,
    marginBottom: 8,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: theme.colors.text,
    marginBottom: 12,
  },
  qaCard: {
    backgroundColor: theme.colors.surface,
    borderRadius: 12,
    padding: 16,
    marginBottom: 12,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.05,
    shadowRadius: 4,
    elevation: 2,
  },
  question: {
    fontSize: 16,
    fontWeight: '600',
    color: theme.colors.text,
    marginBottom: 8,
  },
  answer: {
    fontSize: 14,
    lineHeight: 20,
    color: theme.colors.textSecondary,
  },
  answerInput: {
    fontSize: 14,
    lineHeight: 20,
    color: theme.colors.text,
    borderWidth: 1,
    borderColor: theme.colors.border,
    borderRadius: 8,
    padding: 12,
    minHeight: 80,
  },
  primaryButton: {
    backgroundColor: theme.colors.primary,
    margin: 16,
    paddingVertical: 14,
    borderRadius: 12,
  },
  consentNotice: {
    backgroundColor: theme.colors.warningLight,
    padding: 12,
    margin: 16,
    borderRadius: 8,
    flexDirection: 'row',
    alignItems: 'center',
  },
  consentText: {
    flex: 1,
    marginLeft: 8,
    fontSize: 13,
    color: theme.colors.textSecondary,
  }
});
```

## Verification

### Unit Tests
- Component rendering tests
- State management tests
- Navigation flow tests
- API integration mocks

### Integration Tests
- Full flow from config to export
- Error handling scenarios
- Platform-specific features

### Manual Testing
- Test on iOS, Android, and Web
- Various screen sizes
- Accessibility testing
- Performance with large summaries

## Files Modified

### New Files
- `frontend/src/screens/main/ShareConfigScreen.tsx`
- `frontend/src/screens/main/ShareProcessingScreen.tsx`
- `frontend/src/screens/main/SharePreviewScreen.tsx`
- `frontend/src/screens/main/ShareExportScreen.tsx`
- `frontend/src/components/share/ConsentNotice.tsx`
- `frontend/src/components/share/TemplateSelector.tsx`
- `frontend/src/styles/shareStyles.ts`

### Modified Files
- `frontend/src/navigation/MainNavigator.tsx` (add new screens)
- `frontend/src/navigation/types.ts` (add screen params)
- `frontend/src/screens/main/JournalScreen.tsx` (add share button)
- `frontend/src/services/api.ts` (add share endpoints)

## Estimated Time

- Total: 6.5 hours
- Configuration screen: 2 hours
- Processing screen: 1 hour
- Preview/Edit screen: 2 hours
- Export screen: 1.5 hours

## Dependencies

- Tasks 10-1, 10-2, 10-3 (backend must be ready)
- Task 10-4 (PDF generation)
- Existing encryption/decryption services

## Notes

- Maintain calm visual design throughout
- Ensure smooth transitions between screens
- Handle offline scenarios gracefully
- Consider adding share history in future
- Test thoroughly on all platforms

[Back to task list](./tasks.md)
