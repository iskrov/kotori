# [10-14] Create share preview screen

## Description
Build the share preview screen that displays the generated Q&A pairs before final sharing. This screen allows users to review and edit answers, ensuring accuracy and appropriateness before sharing with caregivers or healthcare providers.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 17:20:00 | Created | N/A | Proposed | Task created | ai-agent |

## Requirements

### Functional Requirements
- Display all Q&A pairs from generated share
- Allow inline editing of answers
- Show confidence indicators for AI-generated content
- Provide share/export actions
- Display metadata (date range, template used)
- Back navigation to template selection

### Technical Requirements
- Full-screen modal or navigation screen
- Editable text components
- Loading state during generation
- Error recovery for failed generation
- Maintain edited state during navigation

## Implementation Plan

### 1. Screen Component
```typescript
// frontend/src/screens/SharePreviewScreen/index.tsx
import React, { useState, useEffect } from 'react';
import { 
  View, 
  ScrollView, 
  Text, 
  TextInput,
  ActivityIndicator,
  Alert 
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useNavigation, useRoute } from '@react-navigation/native';
import { ShareService } from '../../services/ShareService';
import { Button } from '../../components/Button';
import { QAItem } from './components/QAItem';
import { ShareOptions } from './components/ShareOptions';
import styles from './SharePreviewScreen.styles';

interface RouteParams {
  templateId: string;
  dateRange: { start: string; end: string };
  period: 'daily' | 'weekly' | 'monthly';
}

export const SharePreviewScreen: React.FC = () => {
  const navigation = useNavigation();
  const route = useRoute();
  const params = route.params as RouteParams;
  
  const [loading, setLoading] = useState(true);
  const [shareData, setShareData] = useState<any>(null);
  const [editedAnswers, setEditedAnswers] = useState<Map<string, string>>(new Map());
  const [showShareOptions, setShowShareOptions] = useState(false);
  
  useEffect(() => {
    generateShare();
  }, []);
  
  const generateShare = async () => {
    try {
      setLoading(true);
      const response = await ShareService.createShare({
        template_id: params.templateId,
        entry_ids: await getEntryIds(),
        target_language: 'en', // Get from user settings
        expires_in_days: 7
      });
      
      setShareData(response);
    } catch (error) {
      Alert.alert(
        'Generation Failed',
        'Unable to create share summary. Please try again.',
        [
          { text: 'Retry', onPress: generateShare },
          { text: 'Cancel', onPress: () => navigation.goBack() }
        ]
      );
    } finally {
      setLoading(false);
    }
  };
  
  const handleAnswerEdit = (questionId: string, newAnswer: string) => {
    const updated = new Map(editedAnswers);
    updated.set(questionId, newAnswer);
    setEditedAnswers(updated);
  };
  
  const handleConfirmShare = async () => {
    // Apply edits if any
    if (editedAnswers.size > 0) {
      // Update share with edited answers
      await ShareService.updateShare(shareData.id, {
        edited_answers: Object.fromEntries(editedAnswers)
      });
    }
    
    setShowShareOptions(true);
  };
  
  if (loading) {
    return (
      <SafeAreaView style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#2D5A87" />
        <Text style={styles.loadingText}>
          Generating your summary...
        </Text>
        <Text style={styles.loadingSubtext}>
          This may take a few moments
        </Text>
      </SafeAreaView>
    );
  }
  
  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity onPress={() => navigation.goBack()}>
          <Ionicons name="arrow-back" size={24} color="#1A1A1A" />
        </TouchableOpacity>
        <Text style={styles.title}>Review Summary</Text>
        <View style={{ width: 24 }} />
      </View>
      
      <ScrollView 
        style={styles.content}
        showsVerticalScrollIndicator={false}
      >
        <View style={styles.metadata}>
          <Text style={styles.metadataText}>
            {params.period.charAt(0).toUpperCase() + params.period.slice(1)} Summary
          </Text>
          <Text style={styles.dateRange}>
            {formatDateRange(params.dateRange)}
          </Text>
        </View>
        
        {shareData?.content?.answers?.map((qa: any, index: number) => (
          <QAItem
            key={qa.question_id}
            question={qa.question_text}
            answer={editedAnswers.get(qa.question_id) || qa.answer}
            confidence={qa.confidence}
            onEdit={(newAnswer) => handleAnswerEdit(qa.question_id, newAnswer)}
            isLast={index === shareData.content.answers.length - 1}
          />
        ))}
      </ScrollView>
      
      <View style={styles.footer}>
        <Button
          title="Share Summary"
          onPress={handleConfirmShare}
          variant="primary"
          icon="share-outline"
        />
        <Text style={styles.footerNote}>
          You can edit any answer by tapping on it
        </Text>
      </View>
      
      <ShareOptions
        visible={showShareOptions}
        onClose={() => setShowShareOptions(false)}
        shareId={shareData?.id}
        shareToken={shareData?.share_token}
      />
    </SafeAreaView>
  );
};
```

### 2. Q&A Item Component
```typescript
// components/QAItem.tsx
interface QAItemProps {
  question: string;
  answer: string;
  confidence: number;
  onEdit: (newAnswer: string) => void;
  isLast: boolean;
}

export const QAItem: React.FC<QAItemProps> = ({
  question,
  answer,
  confidence,
  onEdit,
  isLast
}) => {
  const [isEditing, setIsEditing] = useState(false);
  const [editedText, setEditedText] = useState(answer);
  
  const handleSave = () => {
    onEdit(editedText);
    setIsEditing(false);
  };
  
  return (
    <View style={[styles.qaContainer, !isLast && styles.qaBorder]}>
      <Text style={styles.question}>{question}</Text>
      
      {isEditing ? (
        <View style={styles.editContainer}>
          <TextInput
            style={styles.editInput}
            value={editedText}
            onChangeText={setEditedText}
            multiline
            autoFocus
          />
          <View style={styles.editActions}>
            <TouchableOpacity onPress={() => setIsEditing(false)}>
              <Text style={styles.cancelText}>Cancel</Text>
            </TouchableOpacity>
            <TouchableOpacity onPress={handleSave}>
              <Text style={styles.saveText}>Save</Text>
            </TouchableOpacity>
          </View>
        </View>
      ) : (
        <TouchableOpacity 
          onPress={() => setIsEditing(true)}
          activeOpacity={0.7}
        >
          <Text style={styles.answer}>{answer}</Text>
          {confidence < 0.7 && (
            <View style={styles.confidenceWarning}>
              <Ionicons name="information-circle" size={16} color="#FFA500" />
              <Text style={styles.confidenceText}>
                Low confidence - please review
              </Text>
            </View>
          )}
        </TouchableOpacity>
      )}
    </View>
  );
};
```

### 3. Visual Design
```
Preview Screen Layout:
┌─────────────────────────┐
│ ← Review Summary      │ Header
├─────────────────────────┤
│ Weekly Summary          │ Metadata
│ Jan 20-26, 2025        │
├─────────────────────────┤
│ Q1: How has your mood...│ Q&A List
│ [Answer text...]        │ (Scrollable)
│ [Tap to edit]          │
│                        │
│ Q2: Sleep quality...    │
│ [Answer text...]        │
│                        │
├─────────────────────────┤
│ [Share Summary]         │ Footer
│ Tap any answer to edit  │
└─────────────────────────┘
```

## Test Plan

### Unit Tests
- Q&A items render correctly
- Edit mode toggles properly
- Answer updates save
- Navigation works
- Share options modal opens

### Integration Tests
- Share generation API call
- Error handling for failures
- Edited answers persist
- Share token generation
- PDF download works

### UI Tests
- Smooth scrolling
- Edit interactions intuitive
- Loading state displays
- Error alerts show
- Accessibility compliant

## Verification

### Success Criteria
- [ ] Preview loads with Q&A pairs
- [ ] Questions display clearly
- [ ] Answers are editable
- [ ] Confidence indicators show
- [ ] Share options work
- [ ] Navigation functions
- [ ] Matches design system

### Edge Cases
- Very long answers
- Network failure during generation
- No journal entries found
- Template with many questions
- Low confidence on all answers

## Files Modified
- `frontend/src/screens/SharePreviewScreen/index.tsx` (new)
- `frontend/src/screens/SharePreviewScreen/components/QAItem.tsx` (new)
- `frontend/src/screens/SharePreviewScreen/components/ShareOptions.tsx` (new)
- `frontend/src/screens/SharePreviewScreen/SharePreviewScreen.styles.ts` (new)
- `frontend/src/navigation/types.ts` (add route)

## Dependencies
- ShareService API integration
- Share options modal (10-15)
- Navigation from ShareScreen
- Journal entry selection logic

## Notes
- Prioritize readability of Q&A pairs
- Make editing intuitive and obvious
- Consider auto-save for edits
- Add character limit for answers
- Prepare for offline editing support

