# [9-1] Create standardized UUID schema migration

[Back to task list](./tasks.md)

## Description

Create a comprehensive database migration that drops existing tables and recreates them with a standardized UUID schema. This migration will serve as the foundation for all subsequent UUID-based improvements and must ensure data consistency across all models.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-22 12:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-01-22 14:00:00 | Status Update | Proposed | Agreed | Task approved for implementation | User |
| 2025-01-22 14:30:00 | Status Update | Agreed | InProgress | Started UUID schema migration implementation | AI Agent |
| 2025-01-22 15:00:00 | Status Update | InProgress | Review | UUID schema migration completed - migration file created | AI Agent |
| 2025-01-22 15:30:00 | Status Update | Review | Done | Migration validated and accepted | User |

## Requirements

### Core Requirements
- Drop existing tables in proper dependency order to avoid foreign key constraint violations
- Recreate tables with native UUID primary keys for all core models
- Maintain OPAQUE model compatibility with String(36) primary keys
- Ensure proper foreign key relationships between all models
- Implement timestamping using the existing TimestampMixin pattern

### Specific Model Requirements

1. **User Model**: Already uses UUID - verify and maintain current implementation
2. **Journal Entry Model**: Convert from integer to UUID primary key
3. **Tag Model**: Convert from integer to UUID primary key  
4. **Reminder Model**: Convert from integer to UUID primary key
5. **Monitoring Model**: Already uses UUID - verify and maintain current implementation
6. **Secret Tag OPAQUE Model**: Fix type confusion by using UUID primary key and separate `phrase_hash` column

### Migration Script Requirements
- Use Alembic for migration management
- Include proper rollback procedures
- Validate schema after migration
- Include data validation checks (even though databases are empty)

## Implementation Plan

### Phase 1: Analysis and Preparation
1. **Analyze Current Schema**
   - Review existing model definitions in `backend/app/models/`
   - Document current foreign key relationships
   - Identify dependency order for table dropping

2. **Create Migration Script**
   - Generate new Alembic migration file
   - Implement `upgrade()` function with table recreation
   - Implement `downgrade()` function for rollback

### Phase 2: Schema Definition
1. **Define New Schema**
   - Create standardized UUID primary key definitions
   - Define proper foreign key constraints
   - Include timestamp columns using TimestampMixin

2. **Model-Specific Changes**
   ```python
   # Journal Entry Model (example)
   class JournalEntry(Base, TimestampMixin):
       __tablename__ = "journal_entries"
       
       id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
       user_id = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False)
       # ... other fields
   ```

### Phase 3: Migration Implementation
1. **Drop Tables in Dependency Order**
   - Drop child tables first (journal_entries, tags, reminders)
   - Drop parent tables last (users)
   - Handle secret_tag_opaque separately

2. **Create Tables with New Schema**
   - Create parent tables first (users)
   - Create child tables with proper foreign key references
   - Validate foreign key constraints

### Phase 4: Validation
1. **Schema Validation**
   - Verify all tables created successfully
   - Check primary key types are correct
   - Validate foreign key relationships

2. **Test Migration**
   - Run migration on clean test database
   - Verify rollback functionality
   - Test with sample data insertion

## Test Plan

### Objective
Verify that the UUID schema migration correctly creates all tables with proper relationships and constraints.

### Test Scope
- Migration execution on clean database
- Schema validation after migration
- Foreign key constraint validation
- Rollback functionality

### Test Environment
- Local development database (PostgreSQL 14+)
- Test database environment
- Alembic migration framework

### Key Test Scenarios

1. **Migration Execution**
   - Clean database migration succeeds
   - All tables created with correct schema
   - Primary keys are proper UUID types
   - Foreign key relationships established

2. **Schema Validation**
   - All models can be imported successfully
   - SQLAlchemy can create sessions
   - Basic CRUD operations work with UUID values

3. **Rollback Testing**
   - Rollback migration succeeds
   - Database returns to previous state
   - Re-migration works correctly

4. **Error Handling**
   - Migration fails gracefully on errors
   - Proper error messages for constraint violations
   - Database remains in consistent state on failure

### Success Criteria
- Migration completes without errors
- All tables exist with UUID primary keys
- Foreign key relationships work correctly
- Rollback functionality validates successfully
- No data corruption or constraint violations

## Verification

### Completion Checklist
- [x] Alembic migration file created
- [x] Migration drops existing tables in proper order
- [x] Migration creates new tables with UUID primary keys
- [x] All foreign key relationships preserved
- [x] TimestampMixin applied to all models
- [x] Migration tested on clean database
- [x] Rollback functionality verified
- [x] Schema validation passes

### Technical Validation
- [x] `alembic upgrade head` completes successfully
- [x] Database schema matches expected UUID structure
- [x] All SQLAlchemy models can be imported
- [x] Basic model operations work with UUID values
- [x] Foreign key constraints enforced properly

### Files Modified
- `backend/alembic/versions/1a46576934f6_uuid_standardization.py` - New migration file
- `backend/app/models/` - Model definitions (verification)
- `backend/app/database.py` - Database configuration (if needed)