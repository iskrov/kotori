# [9-1] Implement client-side decryption in journal display components

## Description

The most critical issue is that journal entries show "No content" because the frontend receives encrypted content from the backend but doesn't decrypt it before display. This task implements the immediate fix by adding decryption logic to the components that display journal entries.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-08-12 03:15:00 | Created | N/A | Proposed | Task created for immediate decryption fix | ai-agent |

## Requirements

### Functional Requirements
1. Decrypt journal entry content when displaying in JournalScreen list
2. Decrypt journal entry content when displaying in JournalEntryDetailScreen
3. Maintain loading states during decryption
4. Handle entries that are not encrypted (backward compatibility)
5. Display appropriate error messages for decryption failures

### Technical Requirements
1. Use existing clientEncryption service for decryption
2. Check for encryption fields before attempting decryption
3. Preserve original entry structure for non-encrypted fields
4. Implement async decryption with proper error handling

## Implementation Plan

### Step 1: Analyze Current Display Flow
- Review how JournalScreen fetches and displays entries
- Review how JournalEntryDetailScreen loads entry details
- Identify where decryption should be inserted

### Step 2: Implement Decryption in JournalScreen
```typescript
// In JournalScreen.tsx or useJournalEntries hook
const decryptEntries = async (entries: JournalEntry[]) => {
  return Promise.all(entries.map(async (entry) => {
    if (entry.is_encrypted && entry.encrypted_content) {
      try {
        const decrypted = await encryptedJournalService.decryptEntry(entry);
        return { ...entry, content: decrypted.content };
      } catch (error) {
        console.error('Failed to decrypt entry:', entry.id, error);
        return { ...entry, content: '[Decryption failed]' };
      }
    }
    return entry;
  }));
};
```

### Step 3: Implement Decryption in JournalEntryDetailScreen
```typescript
// In JournalEntryDetailScreen.tsx or useJournalEntry hook
useEffect(() => {
  const loadAndDecryptEntry = async () => {
    const entry = await JournalAPI.getEntry(entryId);
    if (entry.is_encrypted && entry.encrypted_content) {
      const decrypted = await encryptedJournalService.decryptEntry(entry);
      setEntry({ ...entry, content: decrypted.content });
    } else {
      setEntry(entry);
    }
  };
  loadAndDecryptEntry();
}, [entryId]);
```

### Step 4: Update encryptedJournalService
- Ensure decryptEntry method handles per-user encryption
- Add support for both wrapped_key and encrypted_key fields
- Implement proper error handling and logging

### Step 5: Add Loading States
- Show loading indicator while decrypting
- Implement skeleton screens for better UX
- Handle partial decryption failures in lists

## Verification

### Manual Testing
1. Create a new journal entry with recording
2. Verify content is visible in the journal list
3. Verify content is visible in the detail view
4. Test with existing encrypted entries
5. Test with non-encrypted entries (if any)

### Automated Testing
1. Unit tests for decryption logic
2. Integration tests for the full flow
3. Error case testing for corrupted data

### Success Criteria
- [ ] Journal list shows actual content, not "No content"
- [ ] Detail view shows full entry content
- [ ] No regression for existing entries
- [ ] Graceful error handling for failed decryption
- [ ] Performance remains acceptable (< 500ms for list of 20 entries)

## Files Modified

Expected files to modify:
- `frontend/src/screens/main/JournalScreen.tsx`
- `frontend/src/screens/main/JournalEntryDetailScreen.tsx`
- `frontend/src/hooks/useJournalEntries.ts`
- `frontend/src/hooks/useJournalEntry.ts`
- `frontend/src/services/encryptedJournalService.ts`
- `frontend/src/services/clientEncryption.ts`

## Notes

This is the highest priority task as it directly fixes the user-facing issue. The implementation should be done carefully to avoid breaking existing functionality while ensuring all encrypted content becomes visible to users.

[Back to task list](./tasks.md)
