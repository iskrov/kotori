# [4-2] Non-destructive Alembic migration (deprecations)

[Back to task list](../4/tasks.md)

## Description
Add an idempotent migration that marks legacy secret-tag objects as deprecated using comments and disables triggers to guard against writes while `ENABLE_SECRET_TAGS=false`. Provide a full downgrade path.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-08-09 12:22:00 | Created | Proposed | InProgress | Drafted migration `f0d9b1c3f4a1` for Stage 1 deprecations | ai-agent |
| 2025-08-09 12:36:00 | Completed | InProgress | Done | Migration applied successfully with idempotent checks | ai-agent |

## Requirements
- No destructive operations (no drops of tables, indexes, or constraints).
- Idempotent checks (only operate if objects exist).
- Downgrade re-enables triggers and clears comments.

## Implementation Plan
- Add Alembic revision `f0d9b1c3f4a1_deprecate_secret_tag_schema_stage_1.py`:
  - `COMMENT ON TABLE` for `secret_tags`, `wrapped_keys`, `vault_blobs`, `tag_sessions`.
  - `COMMENT ON COLUMN` for references in `journal_entries.secret_tag_id`, `wrapped_keys.tag_id`, `tag_sessions.tag_id`.
  - `ALTER TABLE ... DISABLE TRIGGER ALL` for the legacy tables.
  - Downgrade: enable triggers and null comments.

## Verification
- Apply migration against current dev DB.
- Confirm comments present and triggers disabled.
- Ensure app continues to function with per-user encryption.

## Files Modified
- `backend/migrations/versions/f0d9b1c3f4a1_deprecate_secret_tag_schema_stage_1.py`

