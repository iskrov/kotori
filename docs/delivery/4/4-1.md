# [4-1] Schema inventory and impact report

[Back to task list](../4/tasks.md)

## Description
Enumerate legacy secret-tag tables/columns and all references in models, services, and migrations. Provide a concise impact report to guide Stage 1 (non-destructive deprecation) and Stage 2 (future removal).

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-08-09 12:05:00 | Created | Proposed | InProgress | Task file created and inventory started | ai-agent |
| 2025-08-09 12:35:00 | Completed | InProgress | Done | Schema inventory and impact analysis completed | ai-agent |

## Requirements
- Identify all Postgres objects related to legacy secret-tags.
- Identify ORM models and services referencing those objects.
- Identify migration history creating/modifying those objects.
- Summarize impact and proposed non-destructive actions for Stage 1.

## Inventory

### Database tables and key columns
- secret_tags
  - Legacy fields present in migrations: `tag_id` (UUID PK), `phrase_hash` (BYTEA 16), `salt` (BYTEA 16), `verifier_kv` (BYTEA 32), `opaque_envelope` (BYTEA), `tag_name` (TEXT/STRING), `color_code` (STRING 7), timestamps
  - Indexes/constraints: `idx_secret_tags_user_id`, `idx_secret_tags_phrase_hash`, `idx_secret_tags_user_tag_name`, `idx_secret_tags_user_created`, `unique_user_secret_tag`
- wrapped_keys
  - References secret tag via FK: `tag_id -> secret_tags.tag_id` (later `id`)
- vault_blobs
  - References wrapped key: `wrapped_key_id -> wrapped_keys.id`
- tag_sessions
  - References secret tag: likely `tag_id -> secret_tags.id` (ephemeral sessions)
- journal_entries
  - Optional FK: `secret_tag_id -> secret_tags.tag_id/id`
  - Indexes include `idx_journal_entries_secret_tag_id`

### ORM models (backend/app/models)
- `secret_tag_opaque.py`
  - `SecretTag`, `WrappedKey`, `VaultBlob`, `OpaqueSession`, `TagSession`
- `journal_entry.py`
  - `secret_tag_id = Column(UUID, ForeignKey("secret_tags.id"), nullable=True)`
- `user.py`
  - Relationship: `secret_tags = relationship("SecretTag", back_populates="user")`

### Services and endpoints
- `app/main.py`: secret-tag router included only when `settings.ENABLE_SECRET_TAGS` is true
- `api/v1/endpoints/journal.py`: disables phrase detection when flag is false
- `api/v1/endpoints/speech.py` and `services/speech_service.py`: guard returns/omits detection when flag is false
- `services/entry_processor.py`: gates detection/authentication/secret entry creation behind flag
- `services/secret_tag_service.py`: full secret-tag lifecycle (not reachable when router excluded)

### Migrations (backend/migrations/versions)
- `2c88eb7b741c_initial_schema_with_optimized_indexes_.py`: creates `secret_tags`, `tags`, `journal_entries`, indexes
- `1a46576934f6_uuid_standardization_drop_and_recreate_.py`: recreates schema with `secret_tags(tag_id, phrase_hash, salt, verifier_kv, opaque_envelope, ...)`, `journal_entries.secret_tag_id`, `wrapped_keys.tag_id`, indexes
- `a90e90c33c6f_rename_secret_tags_tag_id_to_id.py`: renames `secret_tags.tag_id` to `id` (align with ORM)
- `714a3380d102_increase_hashed_password_length_for_.py`: manipulates `journal_entries` indexes including on `secret_tag_id`

## Impact Analysis
- Secret-tag features are globally disabled (`ENABLE_SECRET_TAGS=false`). Core journaling and per-user encryption flows do not require secret-tag tables.
- Residual schema remains in place and is referenced by ORM relationships and optional request fields. With the flag off, code paths should not read/write these tables, but additional guard rails will be added to ensure no accidental usage.

## Proposed Stage 1 (non-destructive) actions
- Alembic migration to:
  - Add `COMMENT ON` notes marking `secret_tags`, `wrapped_keys`, `vault_blobs`, `tag_sessions`, and related FKs as DEPRECATED (Stage 1).
  - `ALTER TABLE ... DISABLE TRIGGER ALL` on the legacy tables (idempotent, non-destructive).
  - No drops; no column removals.
  - Provide downgrade to re-enable triggers and clear comments.
- Service guard rails:
  - When `ENABLE_SECRET_TAGS=false`, ignore any incoming `secret_tag_id/hash` fields and avoid queries touching legacy tables.
  - Ensure secret-tag router remains excluded.

## Verification
- Apply migration on current dev DB (PG17).
- Start services, run OPAQUE smoke (`frontend/scripts/opaque-smoke.js`) and perform encrypted journal CRUD.
- Confirm no writes to `secret_tags`/`wrapped_keys`/`vault_blobs`/`tag_sessions` and no reads occur while flag is disabled.

## Files Modified
- `docs/delivery/4/tasks.md` (status update for 4-1)
- `docs/delivery/4/4-1.md` (this report)


