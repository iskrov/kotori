# [4-4] Integration check on current dev DB

[Back to task list](../4/tasks.md)

## Description
Apply Stage 1 migration on the current PG17 dev database; start services; run OPAQUE smoke plus per-user encrypted journal CRUD; verify legacy secret-tag tables remain unchanged.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-08-09 12:28:00 | Created | Proposed | InProgress | Planned steps and commands documented | ai-agent |
| 2025-08-09 12:38:00 | Completed | InProgress | Done | Integration tests passed: OPAQUE auth + encrypted CRUD working, secret-tag endpoints disabled | ai-agent |

## Requirements
- Migration `f0d9b1c3f4a1` applies cleanly; idempotent; downgrade works.
- App flows: OPAQUE auth + create/read/update/delete journal with per-user encryption.
- No writes to `secret_tags`, `wrapped_keys`, `vault_blobs`, `tag_sessions` while flag OFF.

## Procedure
1. Stop services: `./scripts/stop.sh`
2. Apply migration:
   - `cd backend && conda run -n kotori alembic upgrade head`
3. Start services: `./scripts/start.sh`
4. Run OPAQUE smoke: `node frontend/scripts/opaque-smoke.js`
5. Exercise encrypted CRUD via frontend or API helper.
6. Verify legacy tables unchanged (row counts steady):
   - `psql -c "SELECT 'secret_tags', count(*) FROM secret_tags UNION ALL SELECT 'wrapped_keys', count(*) FROM wrapped_keys UNION ALL SELECT 'vault_blobs', count(*) FROM vault_blobs UNION ALL SELECT 'tag_sessions', count(*) FROM tag_sessions;"`

## Files Modified
- None


