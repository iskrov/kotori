# [4-5] Fix Frontend Error Categorization

[Back to task list](./tasks.md)

## Description

Update error categorization logic and constants mapping in the error handling system to ensure proper error classification, user-friendly messages, and consistent error recovery suggestions.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|---------|
| 2025-01-21 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-01-21 03:15:00 | Status Update | Proposed | InProgress | Started frontend error categorization fixes | AI Agent |
| 2025-01-21 03:45:00 | Status Update | InProgress | Review | Completed error categorization fixes | AI Agent |

## Requirements

### Functional Requirements
1. **Error Category Mapping**
   - Fix error type to category mapping in error handling utilities
   - Ensure all error types have proper category assignments
   - Update error category constants and enums

2. **Error Classification Logic**
   - Fix error classification functions to properly identify error types
   - Update severity assignment logic for different error categories
   - Ensure consistent error handling across all error types

3. **Message and Recovery Updates**
   - Update error messages to match corrected error categories
   - Fix recovery suggestions for properly categorized errors
   - Ensure help URLs and support codes are accurate

### Non-Functional Requirements
1. **Security**: Error messages must not leak sensitive information
2. **User Experience**: Error messages should be helpful and actionable
3. **Consistency**: Error handling should be consistent across the application

## Implementation Plan

### Step 1: Analyze Current Error Categorization Issues
1. Review error handling test failures to identify categorization problems
2. Examine error type definitions and category mappings
3. Identify inconsistencies in error classification logic
4. Document specific issues with error category assignments

### Step 2: Fix Error Type Definitions
1. Update error type interfaces in `frontend/src/types/errorTypes.ts`:
   ```typescript
   export enum ErrorCategory {
     AUTHENTICATION = 'authentication',
     NETWORK = 'network',
     CRYPTOGRAPHIC = 'cryptographic',
     VALIDATION = 'validation',
     SYSTEM = 'system',
     SESSION = 'session',
     VOICE_PROCESSING = 'voice_processing'
   }
   ```

2. Ensure all error types have correct category assignments:
   ```typescript
   export interface ErrorType {
     code: string;
     category: ErrorCategory;
     severity: ErrorSeverity;
     // ... other properties
   }
   ```

### Step 3: Update Error Classification Logic
1. Fix `classifyError` function in `frontend/src/utils/errorHandling.ts`:
   ```typescript
   export function classifyError(error: Error): ErrorClassification {
     // Fix logic to properly map error types to categories
     // Ensure consistent severity assignment
     // Handle edge cases and unknown errors
   }
   ```

2. Update error category detection:
   - Fix pattern matching for different error types
   - Ensure proper fallback for unrecognized errors
   - Update error code mapping logic

### Step 4: Fix Error Messages and Recovery
1. Update `frontend/src/utils/secureErrorMessages.ts`:
   - Fix message mapping for corrected error categories
   - Update recovery suggestions to match error types
   - Ensure help URLs are appropriate for each category

2. Update error recovery logic:
   - Fix recovery strategy selection based on error category
   - Ensure retry logic is appropriate for each error type
   - Update fallback mechanisms

### Step 5: Update Tests
1. Fix error handling tests to match corrected categorization
2. Add test cases for edge cases and error scenarios
3. Ensure test coverage for all error categories
4. Update mock error objects to use correct categorization

## Test Plan

### Test Objectives
- Verify error categorization works correctly for all error types
- Ensure error messages are appropriate and secure
- Confirm recovery suggestions match error categories
- Validate consistent error handling across the application

### Test Environment
- Frontend development environment
- Jest test runner with updated configuration
- Mock error scenarios for comprehensive testing

### Test Scenarios

#### Scenario 1: Error Category Assignment
**Given** various error types
**When** error categorization is performed
**Then** errors are assigned to correct categories

#### Scenario 2: Error Message Generation
**Given** categorized errors
**When** error messages are generated
**Then** messages are user-friendly and category-appropriate

#### Scenario 3: Recovery Suggestion Logic
**Given** different error categories
**When** recovery suggestions are generated
**Then** suggestions are relevant and actionable

#### Scenario 4: Security Validation
**Given** error scenarios with sensitive information
**When** error messages are generated
**Then** no sensitive information is exposed

### Success Criteria
1. **Correct Categorization**: All error types are properly categorized
2. **Appropriate Messages**: Error messages match error categories
3. **Relevant Recovery**: Recovery suggestions are appropriate for error types
4. **Security Compliance**: No sensitive information leaked in error messages

## Verification

### Pre-Implementation Verification
- [ ] Document current error categorization issues
- [ ] Identify specific test failures related to categorization
- [ ] Review error type definitions and mappings

### Implementation Verification
- [ ] Error type to category mapping updated correctly
- [ ] Error classification logic fixed and tested
- [ ] Error messages and recovery suggestions updated

### Post-Implementation Verification
- [ ] Run error handling tests successfully
- [ ] Test error categorization with various error types
- [ ] Verify error messages are appropriate and secure
- [ ] Check recovery suggestions work correctly

### Acceptance Criteria
- [ ] All error handling tests pass without categorization errors
- [ ] Error types are correctly mapped to appropriate categories
- [ ] Error messages are user-friendly and don't expose sensitive information
- [ ] Recovery suggestions are relevant and actionable

## Files Modified

### Core Error Handling Files
- `frontend/src/types/errorTypes.ts` - Error type definitions and categories
- `frontend/src/utils/errorHandling.ts` - Error classification and handling logic
- `frontend/src/utils/secureErrorMessages.ts` - Error messages and recovery suggestions

### Service Files
- `frontend/src/services/ErrorLogger.ts` - Error logging with correct categorization
- `frontend/src/services/ErrorRecovery.ts` - Error recovery based on categories

### Component Files
- `frontend/src/components/ErrorDisplay.tsx` - Error display with correct categorization
- `frontend/src/hooks/useErrorHandler.ts` - Error handling hook updates

### Test Files
- `frontend/src/utils/__tests__/errorHandling.test.ts` - Updated error handling tests
- Other test files that depend on error categorization

## Dependencies

### Blocking Dependencies
- **Error Type System**: Complete error type definitions must be in place

### Related Tasks
- **Task 4-4**: React Native OPAQUE testing (may affect error handling in tests)
- **Task 4-6**: Jest configuration (may affect test execution)

## Risk Assessment

### Medium Risk
- **Logic Complexity**: Error categorization logic is complex and error-prone
- **Test Coverage**: Fixing categorization might reveal gaps in test coverage

### Low Risk
- **User Impact**: Changes primarily affect error handling, not core functionality
- **Rollback**: Changes are localized and easy to rollback

### Mitigation Strategies
- **Incremental Updates**: Fix one error category at a time
- **Comprehensive Testing**: Test all error scenarios thoroughly
- **Code Review**: Review error categorization logic carefully
- **Documentation**: Document error categorization rules clearly

## Implementation Details

### Issues Identified and Fixed

1. **Missing SESSION_EXPIRED Error Type**
   - Problem: Tests and services referenced `ErrorType.SESSION_EXPIRED` but it wasn't defined in the enum
   - Solution: Added `SESSION_EXPIRED = 'session_expired'` to the ErrorType enum in `errorTypes.ts`

2. **Incorrect Error Category Mapping Logic**
   - Problem: `getErrorCategory()` function was using `errorType.startsWith('AUTH_')` but enum values are lowercase with underscores (e.g., 'auth_opaque_login_failed')
   - Solution: Fixed the logic to check `errorValue.startsWith('auth_')` etc., using the actual enum string values

3. **Missing Error Messages and Recovery Suggestions**
   - Problem: SESSION_EXPIRED was missing from error message mappings
   - Solution: Added SESSION_EXPIRED entries to ERROR_MESSAGES and RECOVERY_SUGGESTIONS in `secureErrorMessages.ts`

### Files Modified

1. **frontend/src/types/errorTypes.ts**
   - Added `SESSION_EXPIRED = 'session_expired'` to ErrorType enum

2. **frontend/src/utils/errorHandling.ts**
   - Fixed `getErrorCategory()` function to properly check enum string values
   - Added SESSION_EXPIRED to severity classification (medium severity)
   - Added SESSION_EXPIRED to `getUserAction()` function

3. **frontend/src/utils/secureErrorMessages.ts**
   - Added SESSION_EXPIRED error message mapping
   - Added SESSION_EXPIRED recovery suggestions

### Test Results
- Error categorization now correctly maps all error types to appropriate categories
- SESSION_EXPIRED error type properly categorized as SESSION category
- All error handling utilities working with correct categorization logic

### Acceptance Criteria Status
- [x] All error handling tests pass without categorization errors
- [x] Error types are correctly mapped to appropriate categories
- [x] Error messages are user-friendly and don't expose sensitive information
- [x] Recovery suggestions are relevant and actionable 