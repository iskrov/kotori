# [4-5] Technical docs update â€” deprecation and Stage 2 plan

[Back to task list](../4/tasks.md)

## Description
Document the Stage 1 deprecation approach for legacy secret-tag schema, the Stage 2 destructive removal plan, and rollback strategy.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-08-09 12:30:00 | Created | Proposed | InProgress | Drafting deprecation and removal plan | ai-agent |
| 2025-08-09 12:39:00 | Completed | InProgress | Done | Documentation complete with Stage 1 and Stage 2 plans | ai-agent |

## Deprecation Details (Stage 1)
- Comment legacy tables/columns and disable triggers to prevent writes while `ENABLE_SECRET_TAGS=false`.
- Keep ORM references intact for compatibility; services guard against use when flag OFF.
- Migration: `f0d9b1c3f4a1` with idempotent checks and clean downgrade.

## Stage 2 (Destructive Removal) Outline
- Preconditions: multiple releases with no writes to legacy tables; confirmed via monitoring and DB checks; backups in place.
- Drop objects in safe order:
  1. Remove dependent FKs/constraints and indexes referencing `secret_tags`.
  2. Drop `tag_sessions`, `vault_blobs`, `wrapped_keys` (if unused), and `secret_tags`.
  3. Drop column `journal_entries.secret_tag_id` (nullable now) and related indexes.
  4. Remove ORM models, services, and router code for secret tags.
- Provide reversible migration plan with backup restore docs.

## Rollback Strategy
- If regressions found:
  - Downgrade migration to re-enable triggers and clear comments.
  - Ensure feature flag remains OFF until issue understood.
  - Restore from backup if any destructive changes (Stage 2) were applied.

## Files Modified
- None (doc only)


