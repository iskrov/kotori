# [4-3] Service guard rails with feature flag

[Back to task list](../4/tasks.md)

## Description
Ensure services do not read/write secret-tag objects when `ENABLE_SECRET_TAGS=false`. Harden endpoints to ignore `secret_tag_*` inputs and avoid querying legacy tables while the feature is disabled.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-08-09 12:24:00 | Created | Proposed | InProgress | Drafting guards across services and endpoints | ai-agent |
| 2025-08-09 12:37:00 | Completed | InProgress | Done | Guard rails added to journal service to strip secret-tag fields | ai-agent |

## Requirements
- With flag OFF, block or ignore any paths that would touch `secret_tags`, `wrapped_keys`, `vault_blobs`, or `tag_sessions`.
- Journal CRUD should function purely with per-user encryption fields; discard any `secret_tag_id/hash` provided.
- Secret-tag router must remain excluded from app.

## Implementation Plan
- Journal service: on create/update, if flag OFF, strip `secret_tag_id`, `secret_tag_hash`, and related fields before persistence.
- Ensure phrase detection/auth flows are short-circuited behind the flag (already partially implemented in `entry_processor` and endpoints).
- Add safety logs for attempted secret-tag usage while disabled.

## Verification
- Run integration: create/update/delete journal entries and verify no FK values set to secret-tag columns; no queries to secret-tag tables.

## Files Modified
- `backend/app/services/journal_service.py` (guards)
- `backend/app/api/v1/endpoints/journal.py` (ensure detect_phrases bypass)


