# [3-5] Implement Encrypted Entry Creation

[Back to task list](./tasks.md)

## Description

Implement the core encrypted journal entry creation flow that uses OPAQUE session data keys to encrypt journal entries. This task integrates all previous OPAQUE components (client, voice detection, session management, UI) into a complete end-to-end encrypted journaling workflow where voice-activated secret tags automatically create encrypted entries.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-20 15:45:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-01-20 15:50:00 | Status Update | Proposed | Agreed | Task approved for implementation | User |
| 2025-01-20 15:55:00 | Status Update | Agreed | InProgress | Started implementation | AI Agent |
| 2025-01-20 17:30:00 | Status Update | InProgress | Review | Implementation completed | AI Agent |

## Requirements

### Core Functionality

1. **Encrypted Entry Creation Pipeline**
   - Integrate with existing journal entry creation workflow
   - Use OPAQUE session keys for AES-256-GCM encryption
   - Support both voice-activated and manual encrypted entry creation
   - Maintain backward compatibility with unencrypted entries

2. **Session-Based Encryption**
   - Use active OPAQUE session vault keys for encryption
   - Implement automatic session validation before encryption
   - Handle session expiration gracefully during entry creation
   - Support session renewal for long entry creation sessions

3. **Voice-to-Encryption Workflow**
   - Detect voice activation phrases during transcription
   - Automatically switch to encrypted mode when OPAQUE tag detected
   - Encrypt transcribed content using session vault keys
   - Provide real-time encryption status feedback

4. **Entry Storage and Retrieval**
   - Store encrypted entries with metadata (tag ID, encryption method)
   - Implement decryption on entry retrieval when session is active
   - Handle encrypted entries when no active session exists
   - Provide clear indicators for encrypted vs unencrypted entries

5. **Security Requirements**
   - Never store unencrypted content for encrypted entries
   - Use authenticated encryption (AES-256-GCM) with unique nonces
   - Implement secure key derivation from OPAQUE vault keys
   - Clear sensitive data from memory after use

## Implementation Plan

1. **Enhanced Entry Types and Interfaces**
   - Extend journal entry types to support encryption metadata
   - Create encrypted entry creation and retrieval interfaces
   - Add encryption status indicators to entry objects
   - Implement entry classification (encrypted/unencrypted)

2. **Encryption Service Layer**
   - Create EncryptedEntryManager service for entry encryption/decryption
   - Implement AES-256-GCM encryption with OPAQUE vault keys
   - Add secure key derivation using HKDF
   - Implement nonce generation and management

3. **Journal Entry Workflow Integration**
   - Enhance existing JournalForm component for encrypted entries
   - Integrate with VoicePhraseDetector for automatic encryption
   - Add encryption status indicators to entry creation UI
   - Implement real-time encryption feedback

4. **Entry Storage Enhancement**
   - Extend entry storage to handle encrypted content
   - Add encryption metadata to stored entries
   - Implement encrypted entry indexing and search
   - Add entry decryption on retrieval

5. **Session Integration**
   - Connect with SessionManager for active session validation
   - Handle session expiration during entry creation
   - Implement session renewal for long-running entry creation
   - Add session-based entry access control

## Test Plan

**Objective**: Verify that encrypted journal entry creation works end-to-end with OPAQUE authentication, providing secure content encryption while maintaining usability and performance.

**Test Scope**: Entry encryption/decryption, session integration, voice workflow, storage/retrieval, and security validation.

**Environment & Setup**:
- React Native test environment with OPAQUE services
- Real encryption operations (no mocking per user request)
- Existing journal entry test infrastructure
- Voice transcription simulation

**Key Test Scenarios**:

1. **Voice-Activated Encrypted Entry Creation**
   - Voice phrase detection triggers OPAQUE authentication
   - Successful authentication creates active session
   - Transcribed content encrypted with session vault key
   - Encrypted entry stored with proper metadata

2. **Manual Encrypted Entry Creation**
   - User manually selects OPAQUE tag for encryption
   - Session validation and creation if needed
   - Text content encrypted before storage
   - Entry marked as encrypted with tag association

3. **Session-Based Entry Access**
   - Encrypted entries decrypted when session active
   - Encrypted entries show as locked when no session
   - Session expiration during entry creation handled gracefully
   - Session renewal for long entry creation sessions

4. **Mixed Entry Environment**
   - Unencrypted entries continue to work normally
   - Encrypted and unencrypted entries coexist
   - Entry list shows encryption status clearly
   - Search and filtering respect encryption boundaries

5. **Security Validation**
   - Encrypted content never stored in plaintext
   - Vault keys properly derived from OPAQUE session
   - Nonces unique for each encrypted entry
   - Memory cleared after encryption operations

6. **Error Handling and Edge Cases**
   - Session expiration during entry creation
   - Failed encryption operations
   - Corrupted encrypted entries
   - Missing session for encrypted entry access

**Success Criteria**:
- Voice-activated encryption works end-to-end
- Manual encryption integrates seamlessly with existing UI
- Encrypted entries properly stored and retrieved
- Session management works correctly with entry creation
- Security properties maintained (no plaintext storage)
- Performance acceptable (<500ms for encryption operations)

## Verification

1. **Core Functionality Testing**
   - [ ] Voice phrase detection triggers encrypted entry creation
   - [ ] Manual encrypted entry creation works through UI
   - [ ] Encrypted entries stored with proper metadata
   - [ ] Encrypted entries decrypted when session active
   - [ ] Entry encryption status clearly indicated in UI
   - [ ] Mixed encrypted/unencrypted entries handled correctly

2. **Session Integration Testing**
   - [ ] Active OPAQUE sessions enable encrypted entry creation
   - [ ] Session validation occurs before encryption
   - [ ] Session expiration handled gracefully
   - [ ] Session renewal works for long entry creation
   - [ ] No encryption possible without valid session

3. **Security Testing**
   - [ ] AES-256-GCM encryption implemented correctly
   - [ ] Unique nonces generated for each entry
   - [ ] Vault keys properly derived from OPAQUE session
   - [ ] No plaintext content stored for encrypted entries
   - [ ] Memory cleared after encryption operations
   - [ ] Encrypted entries inaccessible without session

4. **Voice Workflow Testing**
   - [ ] Voice phrase detection triggers OPAQUE authentication
   - [ ] Successful authentication enables encrypted transcription
   - [ ] Transcribed content encrypted before storage
   - [ ] Voice workflow provides encryption status feedback
   - [ ] Failed authentication falls back to unencrypted entry

5. **Storage and Retrieval Testing**
   - [ ] Encrypted entries stored with encryption metadata
   - [ ] Entry retrieval respects encryption status
   - [ ] Encrypted content properly decrypted on access
   - [ ] Entry search works with encrypted entries
   - [ ] Entry export handles encryption appropriately

6. **Performance Testing**
   - [ ] Encryption operations complete within 500ms
   - [ ] Entry creation performance acceptable with encryption
   - [ ] Large entry encryption performs adequately
   - [ ] Memory usage remains stable during encryption
   - [ ] Battery impact minimal for encrypted operations

## Files Modified

- `frontend/src/services/EncryptedEntryManager.ts` (new service)
- `frontend/src/types/encryptedEntryTypes.ts` (new types)
- `frontend/src/components/JournalForm.tsx` (enhanced for encryption)
- `frontend/src/services/journalService.ts` (encryption integration)
- `frontend/src/components/EntryCard.tsx` (encryption indicators)
- `frontend/src/hooks/useEncryptedEntry.ts` (new hook)
- `frontend/src/utils/encryptionUtils.ts` (new utilities)
- `frontend/src/services/__tests__/EncryptedEntryManager.test.ts` (new tests)
- `frontend/src/components/__tests__/JournalForm.test.tsx` (enhanced tests) 