# [3-1] Client per-user key derivation

## Description
Implement per-user master key derivation on the client from OPAQUE login material. Replace secret-tag-based wrapping with a per-user master key that wraps per-entry keys. Integrate with `frontend/src/services/encryptedJournalService.ts` and `frontend/src/services/clientEncryption.ts`.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-08-08 01:10:00 | Status Change | Agreed | InProgress | Started implementation for per-user key derivation | ai-agent |
| 2025-08-08 01:28:00 | Status Change | InProgress | Review | Implemented per-user encryption flow on client | ai-agent |

## Requirements
- Derive per-user master key from OPAQUE export key after login.
- Store master key only in memory (no persistent storage).
- Update create/update entry flows to encrypt content with per-entry key wrapped by master key.
- No `secret_tag_id` or tag-derived fields in payloads for normal entries.

## Implementation Plan
- Use `opaqueKeyManager.getExportKey()` and HKDF to derive `UserMasterKey` (AES-GCM).
- Extend `clientEncryption.ts` with `encryptPerUser(content)` that:
  - Generates per-entry AES key
  - Encrypts content with entry key
  - Wraps entry key with master key (AES-GCM) producing `wrappedKey` and `wrapIv`
- Update `encryptedJournalService` to send encrypted fields when `areSecretTagsEnabled()` is false.

## Test Plan
- Unit: mock initialized `opaqueKeyManager`; verify `encryptPerUser` returns ciphertext, iv, wrappedKey, wrapIv, algorithm.
- Integration: run app flow to create an entry; confirm API payload via logs includes encrypted fields and empty `content`.

## Verification
- Save a journal entry; verify network payload contains ciphertext and wrapped key, no `secret_tag_id`.
- Logout clears keys; creating entries requires re-login.

## Files Modified
- `frontend/src/services/clientEncryption.ts`
- `frontend/src/services/encryptedJournalService.ts`
- `frontend/src/contexts/AuthContext.tsx`

[Back to task list](../tasks.md)
