# [3-4] Implement Secret Tag Creation UI on top of existing UI

[Back to task list](./tasks.md)

## Description

Enhance the existing secret tag creation UI to support OPAQUE-based authentication while maintaining the current user interface. This task integrates the OPAQUE client and session management implemented in previous tasks (3-1, 3-2, 3-3) with the existing SecretTagSetup component and TagsManager to provide zero-knowledge secret tag registration.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-20 14:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-01-20 14:05:00 | Status Update | Proposed | Agreed | Task approved for implementation | User |
| 2025-01-20 14:10:00 | Status Update | Agreed | InProgress | Started implementation | AI Agent |
| 2025-01-20 15:30:00 | Status Update | InProgress | Review | Implementation completed | AI Agent |

## Requirements

### Integration Points (Existing Components)
✅ `SecretTagSetup.tsx` - Main secret tag creation component  
✅ `TagsManager.tsx` - Unified tag management interface  
✅ `SecretTagManagerScreen.tsx` - Secret tag management screen  
✅ Legacy `tagManager.createSecretTag()` - Current implementation  

### OPAQUE Integration Requirements

1. **Enhanced Secret Tag Creation Flow**
   - Replace legacy phrase hashing with OPAQUE authentication
   - Integrate OpaqueClient for cryptographic operations
   - Maintain existing UI/UX patterns and validation
   - Support OPAQUE registration and login workflows

2. **Backward Compatibility**
   - Detect legacy vs OPAQUE-based tags
   - Provide migration path for existing tags
   - Graceful fallback for unsupported scenarios
   - Maintain existing tag management functionality

3. **Session Integration**
   - Use SessionManager for tag session handling
   - Leverage VoicePhraseDetector for voice activation
   - Integrate with session analytics and monitoring
   - Support session persistence and recovery

4. **Security Enhancements**
   - Zero-knowledge tag registration with OPAQUE
   - Device fingerprinting for tag security
   - Secure key derivation and storage
   - Protection against replay attacks

5. **User Experience**
   - No breaking changes to existing UI components
   - Enhanced security warnings for OPAQUE tags
   - Clear indication of tag authentication method
   - Improved error handling and feedback

## Implementation Plan

1. **OPAQUE Tag Type System**
   - Extend tag types to include 'opaque' variant
   - Create OPAQUE-specific tag interfaces
   - Implement tag type detection and routing
   - Add migration utilities for legacy tags

2. **Enhanced SecretTagSetup Component**
   - Integrate OpaqueClient for tag registration
   - Add OPAQUE-specific validation and flows
   - Maintain existing UI with enhanced security features
   - Implement phrase confirmation workflow

3. **Extended TagsManager Integration**
   - Support OPAQUE tag creation in existing modals
   - Add tag type indicators and management
   - Integrate session controls for OPAQUE tags
   - Enhance tag operations with OPAQUE features

4. **Service Layer Enhancements**
   - Create OpaqueTagManager service
   - Extend existing tagManager with OPAQUE support
   - Implement tag migration and compatibility
   - Add OPAQUE-specific error handling

5. **UI Component Updates**
   - Add OPAQUE tag indicators and badges
   - Enhance form validation for OPAQUE flows
   - Create session status components
   - Implement tag security level displays

## Test Plan

**Objective**: Verify that OPAQUE-based secret tag creation integrates seamlessly with existing UI while providing enhanced security features without breaking existing functionality.

**Test Scope**: UI components, OPAQUE integration, backward compatibility, session management, and user experience flows.

**Environment & Setup**:
- React Native test environment with OPAQUE services
- Mock OpaqueClient and SessionManager
- Existing tag management test infrastructure
- User interaction simulation

**Mocking Strategy**:
- Mock OpaqueClient registration/authentication flows
- Mock SessionManager for tag session handling
- Mock existing tagManager for compatibility testing
- Mock device fingerprinting and storage

**Key Test Scenarios**:

1. **OPAQUE Tag Creation Flow**
   - Complete OPAQUE tag registration process
   - Phrase confirmation and validation
   - Device fingerprinting integration
   - Session creation after registration

2. **UI Component Integration**
   - SecretTagSetup with OPAQUE authentication
   - TagsManager OPAQUE tag support
   - Form validation with OPAQUE requirements
   - Error handling and user feedback

3. **Backward Compatibility**
   - Legacy tag detection and handling
   - Mixed tag environment functionality
   - Migration flow testing
   - Fallback behavior verification

4. **Session Management Integration**
   - Tag session creation and management
   - Voice phrase detection integration
   - Session persistence and recovery
   - Analytics and monitoring

5. **Security and Error Handling**
   - OPAQUE authentication failure scenarios
   - Network error handling
   - Invalid phrase handling
   - Session security verification

6. **Performance and UX**
   - OPAQUE operations complete within 2 seconds
   - UI responsiveness during authentication
   - Smooth transitions between flows
   - Consistent styling and theming

**Success Criteria**:
- All existing UI components work with OPAQUE integration
- OPAQUE tag registration completes successfully
- Backward compatibility maintained for legacy tags
- Session management integrates seamlessly
- Security properties verified and maintained
- Performance requirements met (<2s for auth operations)

## Verification

1. **Functionality Testing**
   - [ ] OPAQUE tag creation through SecretTagSetup
   - [ ] TagsManager supports OPAQUE tag operations
   - [ ] Session creation after successful registration
   - [ ] Voice phrase detection works with OPAQUE tags
   - [ ] Tag management operations (edit, delete, activate)
   - [ ] Migration from legacy to OPAQUE tags

2. **UI/UX Testing**
   - [ ] Existing UI components unchanged
   - [ ] OPAQUE-specific indicators and feedback
   - [ ] Form validation enhanced for OPAQUE
   - [ ] Error messages clear and actionable
   - [ ] Loading states and progress indication
   - [ ] Responsive design maintained

3. **Integration Testing**
   - [ ] OpaqueClient integration seamless
   - [ ] SessionManager coordination effective
   - [ ] VoicePhraseDetector works with OPAQUE tags
   - [ ] Analytics and monitoring functional
   - [ ] Storage and persistence working correctly

4. **Security Testing**
   - [ ] Zero-knowledge properties maintained
   - [ ] Device fingerprinting prevents hijacking
   - [ ] Session security verified
   - [ ] No sensitive data in storage
   - [ ] Authentication replay protection

5. **Compatibility Testing**
   - [ ] Legacy tags continue to function
   - [ ] Mixed tag environments stable
   - [ ] Migration process smooth and secure
   - [ ] Fallback mechanisms working
   - [ ] No breaking changes to existing features

6. **Performance Testing**
   - [ ] OPAQUE operations under 2 seconds
   - [ ] UI remains responsive during auth
   - [ ] Memory usage stable
   - [ ] Battery impact minimal
   - [ ] Network efficiency maintained

## Files Modified

- `frontend/src/components/SecretTagSetup.tsx` (enhanced for OPAQUE)
- `frontend/src/components/TagsManager.tsx` (OPAQUE support added)
- `frontend/src/services/OpaqueTagManager.ts` (new service)
- `frontend/src/services/tagManager.ts` (extended for OPAQUE)
- `frontend/src/types/opaqueTypes.ts` (new OPAQUE tag types)
- `frontend/src/components/OpaqueTagIndicator.tsx` (new component)
- `frontend/src/hooks/useOpaqueTag.ts` (new hook)
- `frontend/src/components/__tests__/SecretTagSetup.test.tsx` (enhanced tests)
- `frontend/src/services/__tests__/OpaqueTagManager.test.ts` (new tests) 