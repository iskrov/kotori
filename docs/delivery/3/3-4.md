# [3-4] E2E CoS Test

## Description
End-to-end verification of per-user encryption: client encrypts with per-user master key; backend stores encrypted blobs and returns metadata; UI receives decrypted content locally after save.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-08-09 10:15:00 | Status Change | Agreed | InProgress | Started implementing real OPAQUE (no mocks) and E2E CoS test | ai-agent |

## Requirements
- Create entry with per-user encryption when secret-tag feature flag disabled.
- Payload contains `encrypted_content`, `encryption_iv`, `encrypted_key`, `encryption_wrap_iv`, `encryption_algorithm`, and empty `content`.
- Backend response includes `is_encrypted=true` and encrypted metadata.
- Subsequent fetch returns encrypted data; client can decrypt with active session.

## Test Plan
- Setup: Perform OPAQUE login to initialize `opaqueKeyManager`.
- Action: Use `useJournalEntry.save()` to create a new entry; verify network request payload fields (via logs) exclude `secret_tag_*`.
- Verify: Response contains `is_encrypted=true`; UI shows original plaintext content (client-side) while stored content remains encrypted.
- Update: Change the content; verify per-user encryption update path used.

## Files Covered
- `frontend/src/services/clientEncryption.ts`
- `frontend/src/services/encryptedJournalService.ts`
- `backend/app/schemas/journal.py`
- `backend/app/api/v1/endpoints/journal.py`
- `backend/app/services/journal_service.py`

[Back to task list](../tasks.md)
