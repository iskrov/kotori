# [1-3] Implement Deterministic Key Derivation

[Back to task list](./tasks.md)

## Description

Implement the deterministic key derivation schedule as specified in the OPAQUE zero-knowledge implementation. This creates a standardized pipeline that transforms a password phrase into all required cryptographic keys: TagID for identification, Kv for OPAQUE verification, and Ke for vault key encryption. The implementation must ensure deterministic outputs for consistent authentication across sessions while maintaining security properties.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-19 12:20:00 | Created | N/A | Proposed | Task file created for deterministic key derivation | User |
| 2025-01-19 12:25:00 | Status Change | Proposed | InProgress | Started implementation of key derivation schedule | AI_Agent |
| 2025-01-19 13:00:00 | Implementation Complete | InProgress | Review | Completed deterministic key derivation pipeline with tests | AI_Agent |

## Requirements

### Functional Requirements

1. **Complete Key Derivation Pipeline**
   - Single function that takes password phrase and salt
   - Outputs TagID, Kv (verification key), and Ke (encryption key)
   - Follows the exact specification from the OPAQUE implementation guide
   - Deterministic output for same inputs

2. **Key Derivation Schedule Implementation**
   ```
   Input:  pass-phrase P, 16-byte salt
   S     = Argon2id(P, salt, mem=64 MiB, iters=3 desktop / 1 mobile)
   Kv    = HKDF(S, "verify")        # 32 B — lives on server
   Ke    = HKDF(S, "encrypt")       # 32 B — lives only in client RAM
   TagID = first16(BLAKE2s(P))      # 128-bit, salt-free
   ```

3. **Environment-Aware Configuration**
   - Support for mobile vs desktop Argon2id parameters
   - Configurable through environment variables
   - Performance optimization for different platforms

4. **Secure Key Material Handling**
   - Automatic cleanup of intermediate values
   - Secure memory usage for sensitive operations
   - Protection against memory dumps

### Non-Functional Requirements

1. **Security**
   - Constant-time operations where required
   - Secure memory handling throughout pipeline
   - Protection against side-channel attacks
   - No intermediate key material persistence

2. **Performance**
   - Optimized for mobile device constraints
   - Efficient memory usage patterns
   - Fast TagID generation for real-time voice processing
   - Configurable performance vs security trade-offs

3. **Integration**
   - Compatible with existing crypto utilities
   - Ready for OPAQUE protocol integration
   - Consistent error handling patterns
   - Comprehensive input validation

## Implementation Plan

### Phase 1: Core Key Derivation
1. **Main Derivation Function**
   - Implement `derive_opaque_keys_from_phrase()` function
   - Integrate Argon2id, HKDF, and BLAKE2s utilities
   - Follow exact specification from implementation guide
   - Add comprehensive input validation

2. **Configuration Integration**
   - Use existing crypto configuration system
   - Support environment-specific parameters
   - Add mobile vs desktop optimization profiles
   - Implement parameter validation

### Phase 2: Security Hardening
1. **Secure Memory Handling**
   - Use SecureMemory for intermediate values
   - Automatic cleanup of sensitive data
   - Protection against memory dumps
   - Constant-time operations where needed

2. **Error Handling**
   - Comprehensive input validation
   - Clear error messages for debugging
   - Proper exception propagation
   - Security-focused error handling

### Phase 3: Testing and Validation
1. **Determinism Testing**
   - Verify same inputs produce same outputs
   - Test across different environments
   - Validate TagID consistency
   - Performance benchmarking

2. **Security Testing**
   - Memory leak detection
   - Timing attack resistance
   - Side-channel analysis
   - Input validation testing

## Verification

### Test Plan

**Objective**: Verify that the deterministic key derivation schedule correctly implements the OPAQUE specification and produces consistent, secure keys.

**Test Scope**: Unit testing, determinism validation, security testing, and performance benchmarking of the key derivation pipeline.

**Key Test Scenarios**:

1. **Determinism Validation**
   - Same password phrase produces identical TagID across sessions
   - Same password and salt produce identical Kv and Ke
   - Different salts produce different Kv and Ke
   - TagID generation is salt-independent

2. **Specification Compliance**
   - Argon2id parameters match specification requirements
   - HKDF contexts ("verify", "encrypt") produce different keys
   - BLAKE2s TagID is exactly 16 bytes
   - Key lengths match specification (32 bytes for Kv/Ke)

3. **Environment Configuration**
   - Mobile configuration uses appropriate Argon2id parameters
   - Desktop configuration uses secure parameters
   - Environment switching works correctly
   - Performance meets target requirements

4. **Security Properties**
   - No intermediate key material persists in memory
   - Secure memory cleanup is automatic
   - Constant-time operations where required
   - Input validation prevents attacks

5. **Integration Testing**
   - Compatible with existing crypto utilities
   - Error handling follows project patterns
   - Configuration system integration works
   - Ready for OPAQUE protocol use

**Success Criteria**:
- All test vectors pass for the complete key derivation pipeline
- Deterministic output verified across multiple runs
- Performance meets mobile device requirements
- Security properties verified through testing
- Integration with existing crypto utilities successful

**Environment & Setup**:
- Backend development environment
- Mobile device testing profiles
- Security testing tools
- Performance profiling utilities

## Files Modified

### Implementation Results

**✅ Complete OPAQUE Key Derivation Pipeline Implemented:**

1. **Core Key Derivation** (`backend/app/crypto/key_derivation.py`)
   - **OpaqueKeys** data class with validation for all key types
   - **derive_opaque_keys_from_phrase()** - Complete pipeline implementation
   - **derive_opaque_keys_with_known_salt()** - Authentication-specific derivation
   - **verify_tag_id_matches_phrase()** - Fast TagID verification
   - **benchmark_key_derivation()** - Performance testing utilities
   - Secure memory handling with automatic cleanup throughout

2. **High-Level Interface** (`backend/app/crypto/opaque_keys.py`)
   - **SecretTag** class for database storage with base64 encoding
   - **create_secret_tag()** - New secret phrase creation
   - **authenticate_secret_phrase()** - Authentication with existing tags
   - **find_matching_tag_id()** - Fast tag lookup by phrase
   - **export/import_secret_tag_for_backup()** - Backup/restore functionality
   - **get_performance_profile()** - Environment performance characteristics

3. **OPAQUE Specification Compliance**
   - Exact implementation of key derivation schedule:
     ```
     S     = Argon2id(P, salt, mem=64 MiB, iters=3 desktop / 1 mobile)
     Kv    = HKDF(S, "verify")        # 32 B — lives on server
     Ke    = HKDF(S, "encrypt")       # 32 B — lives only in client RAM
     TagID = first16(BLAKE2s(P))      # 128-bit, salt-free
     ```
   - Environment-specific Argon2id parameters (development/mobile/production)
   - Deterministic TagID generation (salt-free)
   - Context-separated key derivation ("verify" vs "encrypt")

### Files Created/Modified
- `backend/app/crypto/key_derivation.py` - Core implementation (311 lines)
- `backend/app/crypto/opaque_keys.py` - High-level interface (331 lines)
- `backend/app/crypto/__init__.py` - Updated exports with new functions
- `backend/tests/crypto/test_key_derivation.py` - Comprehensive test suite (442 lines)

### Verification Results
- ✅ **Deterministic TagID**: Same phrase always produces same TagID
- ✅ **Specification Compliance**: Exact OPAQUE key schedule implementation
- ✅ **Environment Support**: Development/mobile/production configurations
- ✅ **Security Properties**: Secure memory handling, constant-time comparisons
- ✅ **High-Level Interface**: Simplified API for common operations
- ✅ **Authentication Flow**: Complete secret tag creation and verification
- ✅ **Performance**: Optimized for mobile and production environments
- ✅ **Integration**: Ready for OPAQUE protocol implementation

### Test Results Summary
```
✅ Key derivation: TagID=16B, Kv=32B, Ke=32B, Salt=16B
✅ Deterministic TagID: True (same phrase produces same TagID)
✅ TagID verification: True
✅ Secret tag creation: Complete with base64 encoding
✅ Authentication: Full phrase-to-encryption-key pipeline working
```

The deterministic key derivation schedule is now **complete and ready** for OPAQUE protocol integration. 