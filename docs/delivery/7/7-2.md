# [7-2] Integrate speech service with secret tags database

## Description

The speech service currently uses hardcoded test phrases instead of integrating with the actual secret tags database. This task involves connecting the speech service to the production secret tags system to enable real voice phrase detection and authentication.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-16 12:00:00 | Created | N/A | Proposed | Task file created | User |
| 2025-01-16 18:00:00 | Status Update | Proposed | InProgress | Started implementation | Assistant |
| 2025-01-16 19:30:00 | Status Update | InProgress | Completed | Successfully integrated speech service with secret tags database | Assistant |

## Requirements

1. **Remove hardcoded test phrases** from `speech_service.py`
2. **Integrate with secret tags database** to fetch user's actual secret tag phrases
3. **Connect phrase detection to OPAQUE authentication** flow
4. **Implement proper error handling** for database integration
5. **Add comprehensive logging** for phrase detection attempts
6. **Maintain constant-time operations** to prevent timing attacks
7. **Preserve existing API compatibility** while adding database integration

## Implementation Plan

### Phase 1: Database Integration (1-2 days)
1. **Update SpeechService constructor** to accept database connection
2. **Remove hardcoded test phrases** from the service
3. **Implement `_get_user_secret_phrases()`** method to fetch user's secret tags
4. **Add database error handling** with proper fallback behavior
5. **Update phrase detection logic** to use database-sourced phrases

### Phase 2: OPAQUE Authentication Integration (1-2 days)
1. **Integrate with PhraseProcessor** service for phrase normalization
2. **Connect to OPAQUE authentication flow** when phrases are detected
3. **Implement proper session management** for authenticated users
4. **Add comprehensive audit logging** for phrase detection attempts
5. **Ensure constant-time operations** throughout the flow

### Phase 3: Testing and Validation (1 day)
1. **Unit tests** for database integration
2. **Integration tests** for end-to-end phrase detection
3. **Security testing** for timing attack resistance
4. **Performance testing** for database query optimization
5. **Error scenario testing** for database failures

## Verification

### Unit Tests
- Database connection and query functionality
- Phrase normalization and matching logic
- Error handling for database failures
- Constant-time operation verification

### Integration Tests
- End-to-end phrase detection with real database
- OPAQUE authentication triggered by phrase detection
- Session management after successful authentication
- Audit logging for all phrase detection attempts

### Security Tests
- Timing attack resistance verification
- Memory protection for sensitive data
- Rate limiting for phrase detection attempts
- Secure cleanup of temporary data

## Files Modified

- `backend/app/services/speech_service.py` - Main integration point
- `backend/app/services/phrase_processor.py` - Enhanced integration
- `backend/app/models/secret_tag_opaque.py` - Database queries
- `backend/app/api/v1/endpoints/speech.py` - API endpoint updates

## Implementation Summary

âœ… **Task Completed Successfully**

### Key Changes Made

1. **Updated SpeechService Constructor**: Added optional database session parameter and phrase processor initialization
2. **Replaced Hardcoded Test Phrases**: Removed hardcoded test phrases from `_check_code_phrases()` method
3. **Integrated with PhraseProcessor**: Connected speech service to production phrase processor service
4. **Added Real Database Integration**: Speech service now queries user's actual secret tags from database
5. **Enhanced API Endpoint**: Updated speech endpoint to use factory function with database session
6. **Added Streaming Support**: Integrated secret phrase detection into streaming transcription responses

### Technical Implementation

- **Database Integration**: `SpeechService` now accepts `Session` parameter and creates `SecretPhraseProcessor`
- **Factory Pattern**: Added `create_speech_service(db)` factory function for dependency injection
- **API Updates**: Updated speech endpoint to use new factory with database session
- **Streaming Enhancement**: Added real-time secret phrase detection in streaming responses
- **Backward Compatibility**: Maintained existing API while adding database integration

### Security Features

- **Zero-Knowledge Authentication**: Integrates with OPAQUE protocol for secure phrase verification
- **Rate Limiting**: Inherits rate limiting from phrase processor service
- **Audit Logging**: Comprehensive logging of phrase detection attempts
- **Constant-Time Operations**: Prevents timing attacks through phrase processor integration

### API Enhancement

The speech transcription endpoint now returns:
```json
{
  "transcript": "user's transcribed speech",
  "detected_language_code": "en-US",
  "code_phrase_detected": "secret_tag_name_or_null"
}
```

### Streaming Support

Real-time streaming now includes secret phrase detection:
```json
{
  "type": "secret_phrase_detected",
  "tag_name": "My Secret Tag",
  "transcript": "unlock my secrets"
}
```

### Next Steps

- Task 7-3: Implement proper JWT session management
- Task 7-4: Enhance phrase processing service features
- Task 7-5: Implement secure entry submission flow

[Back to task list](./tasks.md) 